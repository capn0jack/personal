---
schemaVersion: "2.2"
description: "Runs aide"
mainSteps:
- action: "aws:runShellScript"
  name: "runShellScript"
  inputs:
    runCommand:
    - |+
      #!/bin/bash
      apt install --only-upgrade aide aide-common

      echo "==> Update aide config to ignore specific paths"
      cat <<EOF > /etc/aide/aide.conf.d/10_aide_excludes
      !/dev/
      !/home/
      !/opt/aws/amazon-cloudwatch-agent/
      !/proc/
      !/root/
      !/run/
      !/snap/
      !/sys/
      !/tmp/
      !/var/cache/
      !/var/lib/AccountsService/
      !/var/lib/amazon/ssm/
      !/var/lib/apt/
      !/var/lib/arpwatch/
      !/var/lib/clamav/
      !/var/lib/cloud/
      !/var/lib/containerd/daemon/
      !/var/lib/docker/buildkit/cache.db
      !/var/lib/docker/containers/
      !/var/lib/docker/network/files/local-kv.db
      !/var/lib/docker/overlay2
      !/var/lib/docker/runtimes
      !/var/lib/dokku/services/
      !/var/lib/dokku/tmp
      !/var/lib/dokku/volumes/
      !/var/lib/fwupd/
      !/var/lib/lxcfs/
      !/var/lib/nginx/proxy/
      !/var/lib/PackageKit/transactions.db
      !/var/lib/postfix/master.lock
      !/var/lib/rkhunter/db/signatures/
      !/var/lib/snapd
      !/var/lib/systemd/random-seed
      !/var/lib/systemd/timers/
      !/var/lib/systemd/timesync/clock
      !/var/lib/ubuntu-release-upgrader
      !/var/lib/ucf/
      !/var/lib/update-notifier
      !/var/log/
      !/var/ossec/logs/
      !/var/ossec/queue/
      !/var/ossec/rids/
      !/var/run/
      !/var/snap/
      !/var/spool/
      !/var/swap
      !/var/tmp
      EOF

      echo "==> Update aide config"
      update-aide.conf

      echo "==> Running aide"
      ionice -c3 nice -n 19 /usr/bin/aide -c /var/lib/aide/aide.conf.autogenerated -u > /var/log/aide/aidereport.log

      mv /var/lib/aide/aide.db.new /var/lib/aide/aide.db
